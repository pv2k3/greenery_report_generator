<!DOCTYPE html>
<html>
<head>
  <title>Map with Marker, Search, and Result Modal</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #search-box {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      z-index: 5;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
      text-align: left;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: black;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    .error {
      color: red;
      text-align: center;
      padding: 20px;
    }

    .success {
      color: green;
    }

    .report-section {
      margin-bottom: 20px;
    }

    .report-section h4 {
      margin-top: 0;
      color: #333;
    }

    .recommendations {
      max-height: 300px;
      overflow-y: auto;
    }

    .recommendation-item {
      background-color: #f9f9f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      border-left: 4px solid #2c5530;
    }

    .recommendation-item h5 {
      margin: 0 0 5px 0;
      color: #2c5530;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Search Input -->
  <div id="search-box">
    <input id="autocomplete" type="text" placeholder="Search a location..." autocomplete="off" />
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Modal -->
  <div id="resultModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Location Analysis Result</h3>
      <div id="modalBody">Loading...</div>
    </div>
  </div>

  <script>
    // Prevent any navigation or reload
    let isPageUnloading = false;
    
    window.addEventListener('beforeunload', function(e) {
      if (!isPageUnloading) {
        console.log("‚ö†Ô∏è Unexpected page unload detected!");
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Global variables
    let map;
    let marker = null;
    let infoWindow = null;
    let isRequestInProgress = false;
    let autocomplete = null;

    // Modal functions
    function openModal(content) {
      const modal = document.getElementById("resultModal");
      const modalBody = document.getElementById("modalBody");
      modalBody.innerHTML = content;
      modal.style.display = "block";
    }

    function closeModal() {
      const modal = document.getElementById("resultModal");
      modal.style.display = "none";
    }

    // Format analysis result
    function formatAnalysisResult(data) {
      if (!data || typeof data !== 'object') {
        return '<div class="error">Invalid response from server</div>';
      }

      if (data.status === 'error') {
        return `<div class="error">Error: ${data.message}</div>`;
      }

      const report = data.final_report;
      if (!report) {
        return '<div class="error">No analysis report available</div>';
      }

      let html = '<div class="success">‚úÖ Analysis completed successfully!</div>';
      
      // Location info
      if (report.location) {
        html += `<div class="report-section">
          <h4>üìç Location</h4>
          <p>${report.location.city}, ${report.location.country}</p>
        </div>`;
      }

      // Weather data
      if (report.weather_data) {
        const weather = report.weather_data;
        html += `<div class="report-section">
          <h4>üå§Ô∏è Current Weather</h4>
          <p><strong>Temperature:</strong> ${weather.temperature}¬∞C (feels like ${weather.feels_like}¬∞C)</p>
          <p><strong>Humidity:</strong> ${weather.humidity}%</p>
          <p><strong>Condition:</strong> ${weather.weather_description}</p>
          <p><strong>Wind Speed:</strong> ${weather.wind_speed.toFixed(1)} m/s</p>
        </div>`;
      }

      // Land coverage
      if (report.land_coverage) {
        const coverage = report.land_coverage;
        html += `<div class="report-section">
          <h4>üåç Land Coverage Analysis</h4>
          <p><strong>üå± Plant Coverage:</strong> ${coverage.plant_coverage}%</p>
          <p><strong>üè¢ Building Coverage:</strong> ${coverage.building_coverage}%</p>
          <p><strong>üõ£Ô∏è Road Coverage:</strong> ${coverage.road_coverage}%</p>
          <p><strong>üü´ Empty Land:</strong> ${coverage.empty_land}%</p>
        </div>`;
      }

      // Season info
      if (report.season) {
        const season = report.season;
        html += `<div class="report-section">
          <h4>üìÖ Season Information</h4>
          <p><strong>Season:</strong> ${season.season}</p>
          <p><strong>Growing Season:</strong> ${season.is_growing_season ? 'Yes' : 'No'}</p>
          <p><strong>Planting Notes:</strong> ${season.planting_season}</p>
        </div>`;
      }

      // Recommendations
      if (report.recommendations && report.recommendations.length > 0) {
        html += `<div class="report-section">
          <h4>üåø Plant Recommendations</h4>
          <div class="recommendations">`;
        
        report.recommendations.forEach(rec => {
          html += `<div class="recommendation-item">
            <h5>${rec.name}</h5>
            <p><strong>Why:</strong> ${rec.reason}</p>
            <p><strong>Care:</strong> ${rec.care}</p>
          </div>`;
        });
        
        html += '</div></div>';
      }

      return html;
    }

    // Backend request
    function sendToBackend(lat, lng) {
      if (isRequestInProgress) {
        console.log("Request already in progress, skipping...");
        return;
      }

      isRequestInProgress = true;
      
      // Show loading in modal
      openModal('<div class="loading"><div class="loading-spinner"></div><p>Analyzing location... Please wait.</p></div>');

      const formData = new FormData();
      formData.append("latitude", lat);
      formData.append("longitude", lng);
      formData.append("zoom", "18");

      console.log("üöÄ Sending request to backend...");
      
      // Use XMLHttpRequest instead of fetch for better compatibility
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "http://localhost:8000/analyze-location/", true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          isRequestInProgress = false;
          
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
              console.log("‚úÖ Backend response received:", data);
              const formattedContent = formatAnalysisResult(data);
              openModal(formattedContent);
              
              // Update info window
              if (infoWindow) {
                infoWindow.setContent(`<b>Location Analyzed</b><br>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}<br><small>Analysis complete!</small>`);
              }
            } catch (e) {
              console.error("Error parsing response:", e);
              openModal(`<div class="error">Error parsing server response</div>`);
            }
          } else {
            console.error("‚ùå Server error:", xhr.status);
            openModal(`<div class="error">Server error: ${xhr.status}</div>`);
          }
        }
      };

      xhr.onerror = function() {
        isRequestInProgress = false;
        console.error("‚ùå Network error");
        openModal(`<div class="error">Network error. Please check if the backend is running.</div>`);
      };

      xhr.send(formData);
    }

    // Place marker and send request
    function placeMarkerAndSend(lat, lng, label) {
      console.log("üìç Placing marker at:", lat, lng);
      
      // Remove existing marker and info window
      if (marker) {
        marker.setMap(null);
      }
      if (infoWindow) {
        infoWindow.close();
      }

      // Create new marker
      marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: label,
        animation: google.maps.Animation.DROP
      });

      // Create info window
      infoWindow = new google.maps.InfoWindow({
        content: `<b>${label}</b><br>Analyzing location...`,
      });
      
      infoWindow.open(map, marker);

      // Add click listener to marker
      marker.addListener('click', function() {
        if (document.getElementById("resultModal").style.display === "block") {
          closeModal();
        } else {
          infoWindow.open(map, marker);
        }
      });

      // Send to backend
      sendToBackend(lat, lng);
    }

    // Initialize map - THIS IS THE KEY FUNCTION
    function initMap() {
      try {
        console.log("üó∫Ô∏è Initializing map...");
        
        // Create map
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 28.6139, lng: 77.2090 }, // New Delhi
          zoom: 12,
          mapTypeId: 'hybrid',
          disableDefaultUI: false,
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: true,
          fullscreenControl: true
        });

        console.log("‚úÖ Map created successfully");

        // Setup autocomplete
        const input = document.getElementById("autocomplete");
        autocomplete = new google.maps.places.Autocomplete(input, {
          types: ['geocode'],
          componentRestrictions: { country: 'IN' }
        });
        
        autocomplete.bindTo("bounds", map);

        // Handle search selection
        autocomplete.addListener("place_changed", function() {
          const place = autocomplete.getPlace();
          
          if (!place.geometry || !place.geometry.location) {
            console.log("No location data available");
            return;
          }

          const lat = place.geometry.location.lat();
          const lng = place.geometry.location.lng();
          
          console.log("üìç Place selected:", place.name, lat, lng);
          
          // Center map on the selected location
          map.setCenter({ lat, lng });
          map.setZoom(16);
          
          placeMarkerAndSend(lat, lng, place.name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        });

        // Handle map click
        map.addListener("click", function(e) {
          const lat = e.latLng.lat();
          const lng = e.latLng.lng();
          console.log("üñ±Ô∏è Map clicked at:", lat, lng);
          placeMarkerAndSend(lat, lng, `${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        });

        console.log("‚úÖ Map initialization complete");
        
      } catch (error) {
        console.error("‚ùå Error initializing map:", error);
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üìÑ DOM loaded");
      
      // Setup modal close button
      const closeBtn = document.querySelector('.close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }
      
      // Setup input event listeners
      const searchInput = document.getElementById('autocomplete');
      if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        });
      }
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('resultModal');
        if (event.target === modal) {
          closeModal();
        }
      });
    });

    // Make initMap globally available
    window.initMap = initMap;
    
    // Additional safety measures
    window.addEventListener('error', function(e) {
      console.error('üí• Window error:', e.error);
      // Don't prevent default - let it handle naturally
    });

    // Prevent accidental navigation
    window.addEventListener('keydown', function(e) {
      if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
        if (isRequestInProgress) {
          e.preventDefault();
          console.log("‚ö†Ô∏è Preventing refresh during request");
        }
      }
    });
  </script>

  <!-- Google Maps API - Load this properly -->
  <script>
    // Load Google Maps API dynamically to avoid callback issues
    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyC5fDRL96bBfyyYDWpHez86q7mQgSG9s9g&libraries=places&callback=initMap';
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        console.error('‚ùå Failed to load Google Maps API');
      };
      document.head.appendChild(script);
    }

    // Load the API when page is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
    } else {
      loadGoogleMapsAPI();
    }
  </script>
</body>
</html>